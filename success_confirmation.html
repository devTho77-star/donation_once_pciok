<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Successful</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ===== Global Styles ===== */
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body {
      background: linear-gradient(135deg, #f9f7f0 0%, #e8f4f8 100%);
      min-height:100vh; display:flex; justify-content:center; align-items:center;
      padding:20px; overflow-x:hidden;
    }
    .container { max-width:800px; text-align:center; z-index:10; position:relative; }

    /* ===== Success Box ===== */
    .success-content {
      background:white; border-radius:20px; width:90%; max-width:500px; padding:30px; text-align:center;
      box-shadow:0 20px 40px rgba(0,0,0,0.3); position:relative; z-index:1002;
      margin: 0 auto;
    }
    .success-icon {
      width:120px; height:120px;
      background: radial-gradient(circle at 30% 30%, #4CAF50, #2E8B57);
      border-radius:50%; display:flex; justify-content:center; align-items:center;
      margin:0 auto 20px; position: relative; z-index:1002;
      box-shadow: 0 0 20px rgba(76,175,80,0.6), 0 0 40px rgba(76,175,80,0.3) inset;
      animation: iconBounce 2s ease-in-out infinite alternate, iconFloat 3s ease-in-out infinite;
    }
    .success-icon i { font-size:50px; color:white; z-index:1; }

    /* Decorative floating text */
    .success-content h2 { animation: floatHeading 3s ease-in-out infinite; margin-bottom:15px; color: #2E8B57; }
    .success-content p { animation: floatText 3s ease-in-out infinite; }

    /* Action Button */
    .action-button {
      background: linear-gradient(to right,#4CAF50,#2E8B57);
      color:white; border:none; border-radius:8px; padding:12px 24px;
      font-size:16px; font-weight:600; cursor:pointer;
      animation: pulseButton 2s ease-in-out infinite alternate;
      margin-top: 20px;
      display: inline-block;
      text-decoration: none;
    }

    /* Corner decorations */
    .corner-decoration { position:absolute; font-size:80px; color:#4CAF50; opacity:0.1; z-index:1001;
      animation: cornerTwinkle 3s ease-in-out infinite alternate; }
    .corner-top-left { top:10px; left:10px; }
    .corner-top-right { top:10px; right:10px; }
    .corner-bottom-left { bottom:10px; left:10px; }
    .corner-bottom-right { bottom:10px; right:10px; }

    /* Donation Details */
    .donation-details { background:#f8f9fa; border-radius:12px; padding:20px; margin:20px 0; text-align:left; display:none; }
    .donation-details h3 { color:#2c3e50; margin-bottom:15px; font-size:18px; border-bottom:1px solid #e9ecef; padding-bottom:10px; }
    .detail-row { display:flex; justify-content:space-between; margin-bottom:10px; }
    .detail-label { color:#7f8c8d; font-weight:500; }
    .detail-value { color:#2c3e50; font-weight:600; }

    /* Flowers */
    .flower { position:fixed; pointer-events:none; z-index:1001; font-size:24px; opacity:0.9;
      text-shadow:0 0 6px rgba(255,255,255,0.8),0 0 12px rgba(255,192,203,0.6);
      filter: drop-shadow(0 0 6px rgba(255,255,255,0.6)); }
    #flower-ground { position:fixed; bottom:0; left:0; width:100%; height:200px; pointer-events:none; z-index:1001; overflow:visible; }

    /* Loading animation */
    .loading { display: flex; justify-content: center; align-items: center; height: 100px; flex-direction: column; }
    .loading-dot { width: 12px; height: 12px; margin: 0 5px; background-color: #4CAF50; border-radius: 50%; display: inline-block; animation: loading 1.5s infinite ease-in-out both; }
    .loading-dot:nth-child(1) { animation-delay: 0s; }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }

    /* Error message */
    .error-message { color: #e74c3c; background-color: #fde8e6; padding: 15px; border-radius: 8px; margin: 20px 0; display: none; }

    /* ===== Animations ===== */
    @keyframes fadeBounce {0%{opacity:0;transform:translateY(-30px);}60%{opacity:1;transform:translateY(10px);}80%{transform:translateY(-5px);}100%{transform:translateY(0);}}
    @keyframes pulseBtn {0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);}}
    @keyframes pulseButton {0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);}}
    @keyframes floatHeading {0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
    @keyframes floatText {0%,100%{transform:translateY(0);}50%{transform:translateY(-3px);}}
    @keyframes iconBounce {0%{transform:scale(1);}50%{transform:scale(1.1);}100%{transform:scale(1);}}
    @keyframes iconFloat {0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-5px) scale(1.05);}}
    @keyframes haloPulse {0%{transform:translate(-50%,-50%) scale(1);opacity:0.5;}50%{transform:translate(-50%,-50%) scale(1.1);opacity:0.7;}100%{transform:translate(-50%,-50%) scale(1);opacity:0.5;}}
    @keyframes rotateRing {0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes cornerTwinkle {0%{opacity:0.1; transform:scale(1);}50%{opacity:0.15; transform:scale(1.05);}100%{opacity:0.1; transform:scale(1);}}
    @keyframes loading {0%,80%,100%{transform:scale(0);}40%{transform:scale(1);}}
  </style>
</head>
<body>
  <div class="container">
    <div class="success-content">
      <div class="corner-decoration corner-top-left">❀</div>
      <div class="corner-decoration corner-top-right">❀</div>
      <div class="corner-decoration corner-bottom-left">❀</div>
      <div class="corner-decoration corner-bottom-right">❀</div>

      <div class="success-icon"><i class="fas fa-check"></i></div>
      <h2>Payment Successful!</h2>

      <div id="loading-section" class="loading">
        <div>
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
        </div>
        <p>Confirming your payment details...</p>
      </div>

      <div id="error-message" class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        <span id="error-text">There was an issue loading your payment details.</span>
      </div>

      <div id="donation-details" class="donation-details">
        <h3>Donation Details</h3>
        <div class="detail-row"><span class="detail-label">Amount:</span><span class="detail-value" id="success-amount"></span></div>
        <div class="detail-row"><span class="detail-label">Name:</span><span class="detail-value" id="success-name"></span></div>
        <div class="detail-row"><span class="detail-label">Email:</span><span class="detail-value" id="success-email"></span></div>
        <div class="detail-row"><span class="detail-label">On behalf of:</span><span class="detail-value" id="success-on-behalf-of"></span></div>
        <div class="detail-row"><span class="detail-label">Reference ID:</span><span class="detail-value" id="success-reference-id"></span></div>
      </div>

      <a href="index.html" class="action-button"><i class="fas fa-check-circle"></i> Return Home</a>
    </div>
  </div>

  <div id="flower-ground"></div>

  <script>
    // ===== Flowers =====
    const flowers = ['❀','✿','❁'];
    const colors = ['#FF9FF3','#FEA47F','#F97F51','#B33771','#6D214F','#82589F','#2C3A47','#4CAF50','#2E8B57','#ff6f61','#f7b32b','#6a89cc','#78e08f','#e55039'];
    const landedFlowers = [];
    const flowerSpacing = 20;

    window.addEventListener('load', () => {
      createFallingFlowers();
      fetchPaymentDetails();
    });

    function createFallingFlowers() {
      for(let i=0;i<100;i++){ setTimeout(createFlower,i*100); }
    }

    function createFlower() {
      const flower = document.createElement('div');
      flower.className='flower';
      flower.innerHTML=flowers[Math.floor(Math.random()*flowers.length)];
      flower.style.left = Math.random()*window.innerWidth+'px';
      flower.style.top = '-50px';
      flower.style.color = colors[Math.floor(Math.random()*colors.length)];
      flower.style.fontSize = (Math.random()*20+16)+'px';
      flower.style.opacity = Math.random()*0.8+0.4;
      document.body.appendChild(flower);

      const duration = Math.random()*2+2;
      const driftX = (Math.random()-0.5)*100;
      const rotation = (Math.random()>0.5?360:-360)*Math.random();
      const finalScale = Math.random()*0.8+0.6;
      const startLeft=parseFloat(flower.style.left);
      const startTop=parseFloat(flower.style.top);
      const bottomLimit=window.innerHeight-50;
      const startTime=performance.now();

      function animate(time){
        const elapsed=(time-startTime)/1000;
        const progress=Math.min(elapsed/duration,1);
        flower.style.top=startTop+progress*bottomLimit+'px';
        flower.style.left=startLeft+progress*driftX+'px';
        flower.style.transform=`rotate(${rotation*progress}deg) scale(${finalScale})`;
        if(progress<1) requestAnimationFrame(animate);
        else { landedFlowers.push(flower); }
      }
      requestAnimationFrame(animate);
    }

    // ===== Payment Validation =====
    async function fetchPaymentDetails(){
      try{
        const urlParams = new URLSearchParams(window.location.search);
        const paymentIntentId = urlParams.get('payment_intent');
        if(!paymentIntentId) throw new Error('PaymentIntent ID missing');

        const response = await fetch('/.netlify/functions/validate-payment',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ paymentIntentId })
        });

        if(!response.ok){
          const errData = await response.json();
          throw new Error(errData.error || 'Payment validation failed');
        }

        const details = await response.json();
        displayPaymentDetails(details);

      } catch(err){
        document.getElementById('loading-section').style.display='none';
        const errorDiv = document.getElementById('error-message');
        errorDiv.style.display='block';
        document.getElementById('error-text').textContent=err.message;
        console.error(err);
      }
    }

    function displayPaymentDetails(details){
      document.getElementById('loading-section').style.display='none';
      document.getElementById('donation-details').style.display='block';
      document.getElementById('success-amount').textContent = `€${(details.amount/100).toFixed(2)}`;
      document.getElementById('success-name').textContent = mask(details.name,2);
      document.getElementById('success-email').textContent = maskEmail(details.email);
      document.getElementById('success-on-behalf-of').textContent = details.donationBy || 'N/A';
      document.getElementById('success-reference-id').textContent = details.paymentIntentId;
    }

    function mask(str, visible){
      if(!str) return 'N/A';
      return str.split(' ').map(s=>s.substring(0,visible)+'***').join(' ');
    }

    function maskEmail(email){
      if(!email) return 'N/A';
      const [local, domain]=email.split('@');
      return (local.substring(0,2)+'***')+'@'+domain;
    }
  </script>
</body>
</html>
